' Gambas module file

Private iIDProyecto As Integer
Private Contenido As Result

Public Sub CargarMetadatosDesdeArchivo(sRutaArchivo As String)

  Dim sSQL As String

  If Not m_OnOff_y_Red.meConn Or If m_OnOff_y_Red.meConn.Opened = False Then
    m_OnOff_y_Red.OnRed()
  Endif

  Dim sNombreArchivo As String
  sNombreArchivo = File.BaseName(sRutaArchivo)

  ' Usar COALESCE para manejar NULL directamente en SQL
  sSQL = "SELECT id, nombre_archivo, " &
    "COALESCE(txtImagenTapita, '') as txtImagenTapita, " &
    "COALESCE(txtRevistaTitulo, '') as txtRevistaTitulo, " &
    "COALESCE(txtRevistaAbreviatura, '') as txtRevistaAbreviatura, " &
    "COALESCE(txtRevistaDOIPrefix, '') as txtRevistaDOIPrefix, " &
    "COALESCE(txtRevistaISSN, '') as txtRevistaISSN, " &
    "COALESCE(txtRevistaVolumen, '') as txtRevistaVolumen, " &
    "COALESCE(txtRevistaNumero, '') as txtRevistaNumero, " &
    "COALESCE(txtRevistaAnio, '') as txtRevistaAnio, " &
    "COALESCE(txtRevistaMes, '') as txtRevistaMes, " &
    "COALESCE(txtRevistaEditor, '') as txtRevistaEditor, " &
    "COALESCE(txtRevistaEditorial, '') as txtRevistaEditorial, " &
    "COALESCE(txtRevistaPais, '') as txtRevistaPais, " &
    "COALESCE(txtRevistaIdioma, '') as txtRevistaIdioma, " &
    "COALESCE(txtRevistaFrecuencia, '') as txtRevistaFrecuencia, " &
    "COALESCE(txtRevistaURL, '') as txtRevistaURL, " &
    "COALESCE(txtRevistaEmail, '') as txtRevistaEmail, " &
    "COALESCE(txtRevistaISSNPrint, '') as txtRevistaISSNPrint, " &
    "COALESCE(txtRevistaISSNOnLine, '') as txtRevistaISSNOnLine, " &
    "COALESCE(txtRevistaTipoAcceso, '') as txtRevistaTipoAcceso, " &
    "COALESCE(txtRevistaAreaTematica, '') as txtRevistaAreaTematica, " &
    "COALESCE(txtRevistaIndexadaEn, '') as txtRevistaIndexadaEn, " &
    "COALESCE(txtRevistaPoliticaEticaURL, '') as txtRevistaPoliticaEticaURL, " &
    "COALESCE(txtPoliticaRevisoresURL, '') as txtPoliticaRevisoresURL, " &
    "COALESCE(txtPoliticaOpenAccessURL, '') as txtPoliticaOpenAccessURL, " &
    "COALESCE(txtFormatoPublicacion, '') as txtFormatoPublicacion, " &
    "COALESCE(txtRevistaArchivaEn, '') as txtRevistaArchivaEn, " &
    "COALESCE(txtEditorJefe, '') as txtEditorJefe, " &
    "COALESCE(txtEditorJefeEmail, '') as txtEditorJefeEmail, " &
    "COALESCE(txtEditorAsociado, '') as txtEditorAsociado, " &
    "COALESCE(txtEditorAsociadoEmail, '') as txtEditorAsociadoEmail, " &
    "COALESCE(txtCoordinadorEditorial, '') as txtCoordinadorEditorial, " &
    "COALESCE(txtCoordinadorEditorialEmail, '') as txtCoordinadorEditorialEmail, " &
    "COALESCE(txtFechaRecepcionApertura, '') as txtFechaRecepcionApertura, " &
    "COALESCE(txtFechaRecepcionCierre, '') as txtFechaRecepcionCierre, " &
    "COALESCE(txtFechaPublicacion, '') as txtFechaPublicacion, " &
    "COALESCE(txtFechaProximaEdicion, '') as txtFechaProximaEdicion, " &
    "COALESCE(txtLicencia, '') as txtLicencia, " &
    "COALESCE(txtDerechosAutor, '') as txtDerechosAutor, " &
    "COALESCE(txtDepositarioLegal, '') as txtDepositarioLegal, " &
    "COALESCE(cmbTipoCSL, '') as cmbTipoCSL "
    "FROM revistas WHERE nombre_archivo = &1"

  '

  Contenido = m_OnOff_y_Red.meConn.Exec(sSQL, sNombreArchivo)

  If Contenido.Available Then
    iIDProyecto = Contenido["id"]

    ' Ahora puedes asignar directamente sin preocuparte por NULL
    FMain.idMetadatoRevista.Text = Contenido["id"]
    FMain.txtNombreRevista.Text = Contenido["nombre_archivo"]
    FMain.txtImagenTapita.Text = Contenido["txtImagenTapita"]
    FMain.txtRevistaTitulo.Text = Contenido["txtRevistaTitulo"]
    FMain.txtRevistaAbreviatura.Text = Contenido["txtRevistaAbreviatura"]
    FMain.txtRevistaDOIPrefix.Text = Contenido["txtRevistaDOIPrefix"]
    FMain.txtRevistaISSN.Text = Contenido["txtRevistaISSN"]
    FMain.txtRevistaVolumen.Text = Contenido["txtRevistaVolumen"]
    FMain.txtRevistaNumero.Text = Contenido["txtRevistaNumero"]
    FMain.txtRevistaAnio.Text = Contenido["txtRevistaAnio"]
    FMain.txtRevistaMes.Text = Contenido["txtRevistaMes"]
    FMain.txtRevistaEditor.Text = Contenido["txtRevistaEditor"]
    FMain.txtRevistaEditorial.Text = Contenido["txtRevistaEditorial"]
    FMain.txtRevistaPais.Text = Contenido["txtRevistaPais"]
    FMain.txtRevistaIdioma.Text = Contenido["txtRevistaIdioma"]
    FMain.txtRevistaFrecuencia.Text = Contenido["txtRevistaFrecuencia"]
    FMain.txtRevistaURL.Text = Contenido["txtRevistaURL"]
    FMain.txtRevistaEmail.Text = Contenido["txtRevistaEmail"]
    FMain.txtRevistaISSNPrint.Text = Contenido["txtRevistaISSNPrint"]
    FMain.txtRevistaISSNOnLine.Text = Contenido["txtRevistaISSNOnLine"]
    FMain.txtRevistaTipoAcceso.Text = Contenido["txtRevistaTipoAcceso"]
    FMain.txtRevistaAreaTematica.Text = Contenido["txtRevistaAreaTematica"]
    FMain.txtRevistaIndexadaEn.Text = Contenido["txtRevistaIndexadaEn"]
    FMain.txtRevistaPoliticaEticaURL.Text = Contenido["txtRevistaPoliticaEticaURL"]
    FMain.txtPoliticaRevisoresURL.Text = Contenido["txtPoliticaRevisoresURL"]
    FMain.txtPoliticaOpenAccessURL.Text = Contenido["txtPoliticaOpenAccessURL"]
    FMain.txtFormatoPublicacion.Text = Contenido["txtFormatoPublicacion"]
    FMain.txtRevistaArchivaEn.Text = Contenido["txtRevistaArchivaEn"]
    FMain.txtEditorJefe.Text = Contenido["txtEditorJefe"]
    FMain.txtEditorJefeEmail.Text = Contenido["txtEditorJefeEmail"]
    FMain.txtEditorAsociado.Text = Contenido["txtEditorAsociado"]
    FMain.txtEditorAsociadoEmail.Text = Contenido["txtEditorAsociadoEmail"]
    FMain.txtCoordinadorEditorial.Text = Contenido["txtCoordinadorEditorial"]
    FMain.txtCoordinadorEditorialEmail.Text = Contenido["txtCoordinadorEditorialEmail"]
    FMain.txtFechaRecepcionApertura.Text = Contenido["txtFechaRecepcionApertura"]
    FMain.txtFechaRecepcionCierre.Text = Contenido["txtFechaRecepcionCierre"]
    FMain.txtFechaPublicacion.Text = Contenido["txtFechaPublicacion"]
    FMain.txtFechaProximaEdicion.Text = Contenido["txtFechaProximaEdicion"]
    FMain.txtLicencia.Text = Contenido["txtLicencia"]
    FMain.txtDerechosAutor.Text = Contenido["txtDerechosAutor"]
    FMain.txtDepositarioLegal.Text = Contenido["txtDepositarioLegal"]
    FMain.cmbTipoCSL.Text = Contenido["cmbTipoCSL"]
  Else
    Message.Error("No se encontr√≥ el proyecto en la base de datos.")
  Endif

Catch
  Message.Error("Error al cargar metadatos: " & Error.Text)

End

Public Sub GuardarMetadatos()

  Contenido = m_OnOff_y_Red.meConn.Edit("revistas", "id=" & FMain.idMetadatoRevista.Text)

  Contenido!txtImagenTapita = FMain.txtImagenTapita.Text
  Contenido!txtRevistaTitulo = FMain.txtRevistaTitulo.Text
  Contenido!txtRevistaAbreviatura = FMain.txtRevistaAbreviatura.Text
  Contenido!txtRevistaDOIPrefix = FMain.txtRevistaDOIPrefix.Text
  Contenido!txtRevistaISSN = FMain.txtRevistaISSN.Text
  Contenido!txtRevistaVolumen = FMain.txtRevistaVolumen.Text
  Contenido!txtRevistaNumero = FMain.txtRevistaNumero.Text
  Contenido!txtRevistaAnio = FMain.txtRevistaAnio.Text
  Contenido!txtRevistaMes = FMain.txtRevistaMes.Text
  Contenido!txtRevistaEditor = FMain.txtRevistaEditor.Text
  Contenido!txtRevistaEditorial = FMain.txtRevistaEditorial.Text
  Contenido!txtRevistaPais = FMain.txtRevistaPais.Text
  Contenido!txtRevistaIdioma = FMain.txtRevistaIdioma.Text
  Contenido!txtRevistaFrecuencia = FMain.txtRevistaFrecuencia.Text
  Contenido!txtRevistaURL = FMain.txtRevistaURL.Text
  Contenido!txtRevistaEmail = FMain.txtRevistaEmail.Text
  Contenido!txtRevistaISSNPrint = FMain.txtRevistaISSNPrint.Text
  Contenido!txtRevistaISSNOnLine = FMain.txtRevistaISSNOnLine.Text
  Contenido!txtRevistaTipoAcceso = FMain.txtRevistaTipoAcceso.Text
  Contenido!txtRevistaAreaTematica = FMain.txtRevistaAreaTematica.Text
  Contenido!txtRevistaIndexadaEn = FMain.txtRevistaIndexadaEn.Text
  Contenido!txtRevistaPoliticaEticaURL = FMain.txtRevistaPoliticaEticaURL.Text
  Contenido!txtPoliticaRevisoresURL = FMain.txtPoliticaRevisoresURL.Text
  Contenido!txtPoliticaOpenAccessURL = FMain.txtPoliticaOpenAccessURL.Text
  Contenido!txtFormatoPublicacion = FMain.txtFormatoPublicacion.Text
  Contenido!txtRevistaArchivaEn = FMain.txtRevistaArchivaEn.Text
  Contenido!txtEditorJefe = FMain.txtEditorJefe.Text
  Contenido!txtEditorJefeEmail = FMain.txtEditorJefeEmail.Text
  Contenido!txtEditorAsociado = FMain.txtEditorAsociado.Text
  Contenido!txtEditorAsociadoEmail = FMain.txtEditorAsociadoEmail.Text
  Contenido!txtCoordinadorEditorial = FMain.txtCoordinadorEditorial.Text
  Contenido!txtCoordinadorEditorialEmail = FMain.txtCoordinadorEditorialEmail.Text
  Contenido!txtFechaRecepcionApertura = FMain.txtFechaRecepcionApertura.Text
  Contenido!txtFechaRecepcionCierre = FMain.txtFechaRecepcionCierre.Text
  Contenido!txtFechaPublicacion = FMain.txtFechaPublicacion.Text
  Contenido!txtFechaProximaEdicion = FMain.txtFechaProximaEdicion.Text
  Contenido!txtLicencia = FMain.txtLicencia.Text
  Contenido!txtDerechosAutor = FMain.txtDerechosAutor.Text
  Contenido!txtDepositarioLegal = FMain.txtDepositarioLegal.Text
  Contenido!cmbTipoCSL = FMain.cmbTipoCSL.Text

  Message.Info("Cambios guardados correctamente.")
  Contenido.Update
  m_OnOff_y_Red.meConn.Commit()

Catch
  Message.Error("Error al guardar cambios: " & Error.Text)

End
